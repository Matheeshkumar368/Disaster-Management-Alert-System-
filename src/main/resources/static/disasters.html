<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Disaster Monitoring - Tamil Nadu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0f1a2a 0%, #0a1420 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            padding: 1.8rem 1rem;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        }
        .header h1 {
            font-size: 2.4rem;
            color: white;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        .user-role {
            text-align: center;
            padding: 0.8rem;
            font-size: 1.15rem;
            color: #94a3b8;
            background: rgba(30,41,59,0.6);
            margin: 0 1.5rem 1rem;
            border-radius: 12px;
        }
        .user-role strong {
            font-weight: 600;
        }
        .weather-card {
            margin: 1.5rem;
            padding: 1.8rem;
            background: rgba(30, 41, 59, 0.95);
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(59,130,246,0.2);
        }
        .weather-city {
            font-size: 1.7rem;
            margin-bottom: 0.8rem;
            color: #3b82f6;
        }
        .weather-temp {
            font-size: 4.2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        .weather-condition {
            font-size: 1.7rem;
            margin: 0.5rem 0;
        }
        .weather-extra {
            color: #94a3b8;
            font-size: 1.15rem;
            margin-top: 0.8rem;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1.2rem;
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
            justify-content: center;
        }
        .search-box {
            flex: 1 1 300px;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: none;
            border-radius: 50px;
            background: #1e293b;
            color: white;
            font-size: 1.05rem;
        }
        .search-box i {
            position: absolute;
            left: 1.2rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }
        .filter {
            padding: 1rem 1.4rem;
            background: #1e293b;
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 1.05rem;
            cursor: pointer;
            min-width: 170px;
        }
        .alerts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 1.8rem;
            padding: 0 1.5rem 7rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .alert-card {
            background: #1e293b;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
        }
        .alert-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 40px rgba(59,130,246,0.3);
        }
        .alert-header {
            padding: 1.3rem;
            display: flex;
            align-items: center;
            gap: 1.2rem;
        }
        .alert-icon {
            font-size: 2.2rem;
        }
        .alert-type {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .alert-body {
            padding: 0 1.3rem 1.3rem;
        }
        .alert-detail {
            margin: 0.9rem 0;
            color: #94a3b8;
            font-size: 1.05rem;
        }
        .alert-detail i {
            margin-right: 0.7rem;
            width: 22px;
            text-align: center;
        }
        .status-active { color: #22c55e; font-weight: bold; }
        .severity-high { color: #ef4444; }
        .severity-medium { color: #f59e0b; }
        .severity-low { color: #10b981; }
        .time { color: #64748b; font-size: 1rem; }

        .no-alerts {
            text-align: center;
            padding: 5rem 1rem;
            color: #94a3b8;
            font-size: 1.5rem;
        }
        .no-alerts i {
            font-size: 6rem;
            opacity: 0.4;
            margin-bottom: 1.2rem;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e293b;
            display: flex;
            justify-content: space-around;
            padding: 1rem 0;
            box-shadow: 0 -6px 20px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .bottom-nav a {
            color: #94a3b8;
            text-decoration: none;
            text-align: center;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        .bottom-nav a i {
            font-size: 1.9rem;
            display: block;
            margin-bottom: 0.4rem;
        }
        .bottom-nav a.active,
        .bottom-nav a:hover {
            color: #3b82f6;
            transform: translateY(-3px);
        }

        @media (max-width: 768px) {
            .controls { flex-direction: column; }
            .alerts-grid { grid-template-columns: 1fr; }
            .weather-temp { font-size: 3rem; }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>Disaster Monitoring - Tamil Nadu</h1>
</div>

<!-- Logged-in Role Display -->
<div id="userRole" class="user-role">
    Logged in as: <strong id="roleText">Loading...</strong>
</div>

<!-- Weather Card -->
<div id="weatherCard" class="weather-card">
    <h3 id="weatherCity" class="weather-city">Weather in Coimbatore</h3>
    <div id="weatherTemp" class="weather-temp">Loading...</div>
    <div id="weatherCondition" class="weather-condition"></div>
    <div id="weatherExtra" class="weather-extra">
        Feels like â€¢ Humidity â€¢ Rain chance
    </div>
</div>

<div class="controls">
    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search location in Tamil Nadu (e.g. Coimbatore, Dindigul)..."/>
    </div>
    <select class="filter" id="typeFilter">
        <option value="">All Types</option>
        <option value="Heavy Rain">Heavy Rain</option>
        <option value="Cyclone">Cyclone</option>
        <option value="Flood">Flood</option>
        <option value="Dense Fog">Dense Fog</option>
        <option value="Earthquake">Earthquake</option>
        <option value="Other">Other</option>
    </select>
    <select class="filter" id="severityFilter">
        <option value="">All Severities</option>
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
    </select>
</div>

<div class="alerts-grid" id="alertsGrid"></div>

<script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // USER ROLE DISPLAY FROM JWT
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const token = localStorage.getItem('token');
    if (token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const role = payload.role || 'Citizen';
            document.getElementById('roleText').innerText = role;
            document.getElementById('userRole').style.color = 
                role === 'Admin' ? '#00c878' : 
                role === 'Responder' ? '#3b82f6' : '#94a3b8';
        } catch (e) {
            document.getElementById('roleText').innerText = 'Guest';
        }
    } else {
        document.getElementById('roleText').innerText = 'Not logged in';
    }

    const grid = document.getElementById('alertsGrid');
    const searchInput = document.getElementById('searchInput');
    const typeFilter = document.getElementById('typeFilter');
    const severityFilter = document.getElementById('severityFilter');

    const weatherCity = document.getElementById('weatherCity');
    const weatherTemp = document.getElementById('weatherTemp');
    const weatherCondition = document.getElementById('weatherCondition');
    const weatherExtra = document.getElementById('weatherExtra');

    let allAlerts = [];

    // Tamil Nadu city coordinates (expanded list)
    const cityCoords = {
        "coimbatore": { lat: 11.0168, lon: 76.9558 },
        "dindigul":   { lat: 10.3687, lon: 77.9803 },
        "chennai":    { lat: 13.0827, lon: 80.2707 },
        "madurai":    { lat: 9.9252,  lon: 78.1198 },
        "tirunelveli":{ lat: 8.7139,  lon: 77.7567 },
        "salem":      { lat: 11.6643, lon: 78.1460 },
        "tiruchirappalli": { lat: 10.7905, lon: 78.7047 },
        "tiruppur":   { lat: 11.1085, lon: 77.3411 },
        "erode":      { lat: 11.3410, lon: 77.7172 },
        "kanyakumari":{ lat: 8.0883,  lon: 77.5385 },
        "vellore":    { lat: 12.9165, lon: 79.1325 },
        "thanjavur":  { lat: 10.786999, lon: 79.137827 },
        "thoothukudi": { lat: 8.7642, lon: 78.1348 }
    };

    let currentCity = "coimbatore";

    function updateWeather(city) {
        city = city.toLowerCase().trim();
        const coords = cityCoords[city] || cityCoords["coimbatore"];
        const displayCity = city.charAt(0).toUpperCase() + city.slice(1);
        weatherCity.innerText = `Weather in ${displayCity}`;

        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation_probability,weather_code&timezone=Asia%2FKolkata`)
            .then(res => res.json())
            .then(data => {
                if (!data.current) {
                    weatherTemp.innerHTML = 'Unavailable';
                    weatherCondition.innerHTML = '';
                    weatherExtra.innerHTML = '';
                    return;
                }

                const current = data.current;
                const temp = Math.round(current.temperature_2m);
                const feels = Math.round(current.apparent_temperature);
                const humidity = current.relative_humidity_2m;
                const rainChance = current.precipitation_probability;
                const code = current.weather_code;

                let condition = "Sunny";
                let icon = "â˜€ï¸";

                if (code >= 51 && code <= 67) { condition = "Rain"; icon = "ðŸŒ§ï¸"; }
                else if (code >= 80 && code <= 86) { condition = "Showers"; icon = "ðŸŒ¦ï¸"; }
                else if (code === 45 || code === 48) { condition = "Fog"; icon = "ðŸŒ«ï¸"; }
                else if (code >= 61 && code <= 67) { condition = "Heavy Rain"; icon = "â›ˆï¸"; }
                else if (code === 3) { condition = "Overcast"; icon = "â˜ï¸"; }
                else if (code === 2) { condition = "Partly Cloudy"; icon = "â›…"; }

                weatherTemp.innerHTML = `${temp}Â°C ${icon}`;
                weatherCondition.innerHTML = condition;
                weatherExtra.innerHTML = `Feels like ${feels}Â°C â€¢ Humidity ${humidity}% â€¢ Rain chance ${rainChance}%`;
            })
            .catch(err => {
                console.error("Weather error:", err);
                weatherTemp.innerHTML = 'Weather unavailable';
            });
    }

    // Load weather on page load
    updateWeather(currentCity);

    // Update weather when user types a known city
    searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase().trim();
        if (cityCoords[query]) {
            currentCity = query;
            updateWeather(query);
        }
    });

    function renderAlerts(alerts) {
        grid.innerHTML = '';

        if (alerts.length === 0) {
            grid.innerHTML = `
                <div class="no-alerts">
                    <i class="fas fa-cloud-sun-rain"></i>
                    <br>No active alerts right now in Tamil Nadu
                    <br><small>Stay safe â€” check back later or when weather changes</small>
                </div>
            `;
            return;
        }

        alerts.forEach(alert => {
            const card = document.createElement('div');
            card.className = 'alert-card';

            let icon = 'fa-exclamation-triangle';
            let color = '#f59e0b';

            if (alert.type.includes('Heavy Rain') || alert.type.includes('Rain')) {
                icon = 'fa-cloud-rain';
                color = '#3b82f6';
            } else if (alert.type.includes('Cyclone')) {
                icon = 'fa-wind';
                color = '#7c3aed';
            } else if (alert.type.includes('Flood')) {
                icon = 'fa-water';
                color = '#2563eb';
            } else if (alert.type.includes('Fog')) {
                icon = 'fa-smog';
                color = '#64748b';
            } else if (alert.type.includes('Earthquake')) {
                icon = 'fa-house-crack';
                color = '#dc2626';
            }

            card.innerHTML = `
                <div class="alert-header" style="background: ${color}30;">
                    <i class="fas ${icon} alert-icon" style="color:${color}"></i>
                    <div class="alert-type" style="color:${color}">${alert.type}</div>
                </div>
                <div class="alert-body">
                    <div class="alert-detail"><i class="fas fa-map-marker-alt"></i>${alert.location}</div>
                    <div class="alert-detail"><i class="fas fa-exclamation-circle"></i>Severity: <span class="severity-${alert.severity.toLowerCase()}">${alert.severity}</span></div>
                    <div class="alert-detail time"><i class="fas fa-clock"></i>${new Date(alert.timestamp).toLocaleString('en-IN')}</div>
                    <div class="alert-detail status-active"><i class="fas fa-check-circle"></i>${alert.status}</div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function filterAlerts() {
        let filtered = allAlerts;

        const search = searchInput.value.toLowerCase();
        if (search) {
            filtered = filtered.filter(a => 
                a.location.toLowerCase().includes(search) || 
                a.type.toLowerCase().includes(search)
            );
        }

        const type = typeFilter.value;
        if (type) {
            filtered = filtered.filter(a => a.type === type);
        }

        const severity = severityFilter.value;
        if (severity) {
            filtered = filtered.filter(a => a.severity === severity);
        }

        renderAlerts(filtered);
    }

    // Load disaster alerts
    fetch('/api/disasters')
        .then(res => res.json())
        .then(data => {
            allAlerts = data;
            filterAlerts();
        })
        .catch(err => {
            console.error('Error loading alerts:', err);
            renderAlerts([]); // show no alerts message
        });

    // Filters
    typeFilter.addEventListener('change', filterAlerts);
    severityFilter.addEventListener('change', filterAlerts);
</script>

<!-- Bottom Navigation Bar -->
<nav class="bottom-nav">
    <a href="/disasters.html" class="active">
        <i class="fas fa-map-marker-alt"></i>
        <span>Dashboard</span>
    </a>
    <a href="/alerts.html">
        <i class="fas fa-bell"></i>
        <span>Alerts</span>
    </a>
    <a href="/reports.html">
        <i class="fas fa-chart-bar"></i>
        <span>Reports</span>
    </a>
    <a href="/profile.html">
        <i class="fas fa-user"></i>
        <span>Profile</span>
    </a>
</nav>

<style>
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #1e293b;
        display: flex;
        justify-content: space-around;
        padding: 1rem 0;
        box-shadow: 0 -6px 20px rgba(0,0,0,0.5);
        z-index: 1000;
    }
    .bottom-nav a {
        color: #94a3b8;
        text-decoration: none;
        text-align: center;
        font-size: 0.95rem;
        transition: all 0.3s;
    }
    .bottom-nav a i {
        font-size: 1.9rem;
        display: block;
        margin-bottom: 0.4rem;
    }
    .bottom-nav a.active,
    .bottom-nav a:hover {
        color: #3b82f6;
        transform: translateY(-3px);
    }
</style>

</body>
</html>